<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head th:replace="fragment/globalComponent::commonHead(~{::title},~{::link},~{::style})">
    <title>GoblinCwl - 管理</title>
    <link th:href="@{/css/manager.css}" rel="stylesheet"/>
    <style>
        div {
            overflow-x: hidden;
            overflow-y: auto;
        }

        html {
            position: relative;
            min-height: 100%;
        }
    </style>
    <style>
        .managerRightDiv {
            padding: 0;
            border: 5px solid;
        }

        .blackBorder {
            border: 1px solid #000;
        }

        #serverHardwareTable {
            border-collapse: unset;
        }

        #serverHardwareTable td {
            padding: 0.6em;
        }

        #serverHardwareTable span {
            font-size: 16px;
            font-weight: bold;
        }

        #serverHardwareTable .serverHardwareStrip {
            width: 100%;
        }

        #serverHardwareTable .serverHardwareStrip div {
            height: 1.3em;
            background-color: #6ecadc;
            width: 0;
        }


        #threadUlDiv {
            height: 15.3em;
            position: relative;
            border: 0;
            border-top: 1px solid;
        }

        #threadUlDiv ul li {
            float: left;
            position: absolute;
            bottom: 0;
            text-align: center;
            font-weight: bold;
            color: black;
            height: 100%;
            width: 86px;
            list-style: none;
            border: 2px solid #696464;
            border-bottom: 0;
            font-size: 12px;
            font-family: SpacePixel, sans-serif;
            background-image: linear-gradient(-45deg, transparent 0px, #fff 0px, #74b474 10%, transparent 0px, transparent 70%, ghostwhite 0px);
        }

        #threadUlDiv ul li.c1 {
            left: 0;
            background-color: #5e99e5;
            color: #3f679a;
        }

        #threadUlDiv ul li.c2 {
            left: 80px;
            background-color: #65da65;
            color: #377337;
        }

        #threadUlDiv ul li.c3 {
            left: 160px;
            background-color: #e85151;
            color: #9d3333;
        }

        span {
            font-family: SpacePixel, serif
        }

        #consoleDiv {
            font-size: 1px;
            font-family: Hack, sans-serif;
            color: black;
        }

        #consoleDiv p {
            word-break: break-all;
        }

        .blogTopHeat, .tabTopHeat {
            font-size: 1px;
            text-align: center;
            color: gray;
        }

        #tabTopTable td {
            text-align: center;
        }

        #blogTopTable td, #tabTopTable td {
            padding: 0.145em;
        }

        #blogTopTable span, #tabTopTable span {
            font-family: sans-serif;
        }

        .badge-search {
            cursor: pointer;
            margin-right: 0.25em;
            border: 1px solid white;
        }

        .badge-search:hover {
            border: 1px solid black;
            transform: scale(1.2);
        }

        #requestUlDiv li {
            padding: 0.13em;
        }
    </style>
</head>
<body>
<!-- 左侧侧边栏 -->
<div th:replace="fragment/manager/managerComponent::leftSiderBar"></div>

<!-- 页面内容 -->
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="content">
        <!-- 顶部导航 -->
        <div th:replace="fragment/globalComponent::topHeader"></div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-6">
                    <div style="border: 1px solid #000;margin-top: 2em;height: 35em">
                        <div class="col-lg-9 managerRightDiv"
                             style="height: 15.92em;padding: 1em;border-color: #7aa857">
                            <div class="blackBorder" style="height: 100%">
                                <span>TODO - 访问/订阅 线统计图</span>
                            </div>
                        </div>
                        <div class="col-lg-3" style="padding: 0">
                            <div id="accessCountDiv" style="text-align: center;border-color:#58a1af;"
                                 class="managerRightDiv">
                                <div class="blackBorder">
                                    <div style="background-color: #2C7EEA;border-bottom: 1px solid #000">
                                        <span style="font-size: 6px;color: #fff;">总访问</span>
                                        <span id="accessAllCountSpan" style="font-size: 20px;color: #fff;">
                                            <!--总访问数量-->-
                                        </span>
                                    </div>
                                    <span style="font-size: 20px;color: #2C7EEA;font-weight: bold;">今</span>
                                    <span id="accessTodayCountSpan"
                                          style="font-size: 60px;color: #2C7EEA;font-weight: bold;">
                                        <!--今日访问量-->-
                                    </span>
                                </div>
                            </div>
                            <div id="subscriptionCountDiv" style="text-align: center;border-color: #af7f58"
                                 class="managerRightDiv">
                                <div class="blackBorder">
                                    <div style="background-color: #d06b05;border-bottom: 1px solid #000">
                                        <span style="font-size: 6px;color: #fff;">总订阅</span>
                                        <span style="font-size: 20px;color: #fff;">0</span>
                                    </div>
                                    <span style="font-size: 20px;color: #ea9e2c;font-weight: bold;">今</span>
                                    <span style="font-size: 60px;color: #ea9e2c;font-weight: bold;">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="managerRightDiv col-lg-6" style="height: 18.95em">
                            <span>(A place of purity..)</span>
                        </div>
                        <div class="col-lg-6" style="padding: 0">
                            <div class="managerRightDiv" style="border-color: #6ecadc">
                                <div class="blackBorder">
                                    <table id="blogTopTable" style="width: 100%">
                                        <thead>
                                        <tr>
                                            <td style="width: 78%"></td>
                                            <td style="width: 22%"></td>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td><a href="#">&nbsp;1.todo</a></td>
                                            <td class="blogTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><a href="#">&nbsp;2.todo</a></td>
                                            <td class="blogTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><a href="#">&nbsp;3.todo</a></td>
                                            <td class="blogTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><a href="#">&nbsp;4.todo</a></td>
                                            <td class="blogTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><a href="#">&nbsp;5.todo</a></td>
                                            <td class="blogTopHeat">访问: 123</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="managerRightDiv col-lg-6" style="border-color: #446ab2">
                                <div class="blackBorder">
                                    <table id="tabTopTable" style="width: 100%">
                                        <tbody>
                                        <tr>
                                            <td><span class="badge badge-search no-border-radio"
                                                      onclick="tabSearchAppend('测试文章')"
                                                      style=" background-color: #4a2eff">todo</span></td>
                                            <td class="tabTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-search no-border-radio"
                                                      onclick="tabSearchAppend('测试文章')"
                                                      style=" background-color: #18543f">todo</span></td>
                                            <td class="tabTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-search no-border-radio"
                                                      onclick="tabSearchAppend('测试文章')"
                                                      style=" background-color: #ea2eff">todo</span></td>
                                            <td class="tabTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-search no-border-radio"
                                                      onclick="tabSearchAppend('测试文章')"
                                                      style=" background-color: #ea2eff">todo</span></td>
                                            <td class="tabTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge badge-search no-border-radio"
                                                      onclick="tabSearchAppend('测试文章')"
                                                      style=" background-color: #ea2eff">todo</span></td>
                                            <td class="tabTopHeat"><p>访问: 123</p></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="managerRightDiv col-lg-6" style="border-color: #b24482">
                                <div class="blackBorder" style="height: 8.7em">
                                    <span>TODO - 功能热度</span>
                                    <table id="functionTopTable" style="width: 100%">
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div style="border: 1px solid #000;margin-top: 2em;height: 35em">
                        <div class="col-lg-4" style="width: 45%;padding: 0">
                            <div id="serverTimeDiv" class="managerRightDiv"
                                 style="text-align:center;border-color:hsl(120, 30%, 58%)">
                                <div class="blackBorder">
                                    <span id="serverStartTimeSpan" style="font-size: 16px;color: grey">
                                        <!--服务器开始运行时间-->
                                        ////-//-// //://://
                                    </span>
                                    <br>
                                    <span id="serverTimeSpan" style="font-size: 32px;color: green;font-weight: bold">
                                        <!--服务器运行时间-->
                                        -时-分-秒
                                    </span>
                                </div>
                            </div>
                            <div id="gcDiv blackBorder" class="managerRightDiv"
                                 style="text-align:center;border-color:hsl(120, 30%, 58%);border-top: 0">
                                <div class="blackBorder">
                                    <span style="font-size: 16px;color: red">GC - </span>
                                    <span id="gcCountSpan" style="font-size: 16px;color: grey">
                                        <!--GC次数-->
                                    </span>
                                    <span id="gcTimeSpan"
                                          style="font-size: 16px;color: green;font-weight: bold">
                                        <!--GC时间-->
                                    </span>
                                </div>
                            </div>
                            <div id="threadDiv blackBorder" class="managerRightDiv"
                                 style="text-align:center;border-color:hsl(120, 30%, 58%);border-top: 0">
                                <div id="threadUlDiv" class="blackBorder">
                                    <ul>
                                        <li id="jvmGrdThreadLi" class="c1">GRD/</li>
                                        <li id="jvmActThreadLi" class="c2">ACT/</li>
                                        <li id="jvmPekThreadLi" class="c3">PEK/</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="serverHardwareDiv" class="col-lg-4" style="width: 55%;padding: 0">
                            <div class="managerRightDiv" style="text-align:center;border-color:hsl(213,27%,29%)">
                                <table class="blackBorder" id="serverHardwareTable">
                                    <tbody>
                                    <tr>
                                        <td><span id="diskUsageSpan" style="color: grey"
                                                  class="serverHardwareTitleSpan">磁盘</span></td>
                                        <td class="serverHardwareStrip">
                                            <div id="diskUsageDiv" style="background-color: grey"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><span id="memoryUsageSpan" style="color: #17a117"
                                                  class="serverHardwareTitleSpan">内存</span>
                                        </td>
                                        <td class="serverHardwareStrip">
                                            <div id="memoryUsageDiv" style="background-color: #17a117"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><span id="cpuUsageSpan" style="color: coral"
                                                  class="serverHardwareTitleSpan">CPU</span></td>
                                        <td class="serverHardwareStrip">
                                            <div id="cpuUsageDiv" style="background-color: coral"></div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="requestTitleDiv blackBorder" class="managerRightDiv"
                                 style="text-align:left;border-color:hsla(236,58%,58%,0.73);border-bottom: 0">
                                <div id="requestTitleUlDiv" class="blackBorder"
                                     style="padding: 0.14em;text-align: center;color:hsla(236,58%,58%,0.73) ">
                                    <span>- 最多请求接口 -</span>
                                </div>
                            </div>
                            <div id="requestDiv blackBorder" class="managerRightDiv"
                                 style="text-align:left;border-color:hsla(236,58%,58%,0.73)">
                                <div id="requestUlDiv" class="blackBorder">
                                    <ul id="requestUl" style="font-size: 13px;;list-style: none">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="consoleParentDiv" class="managerRightDiv"
                             style="width: 100%;height: 12.3em;border-color: grey">
                            <div id="consoleDiv" class="blackBorder"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</body>
<div th:replace="fragment/globalComponent::commonFoot(~{::script})">
    <script>
        $(function () {
            $("#managerHomeLi").addClass("active")

            //日志输出
            const webSocket = new WebSocket(projectHomeWebSocketUrl + "/log");
            //处理服务器返回的信息
            webSocket.onmessage = function (event) {
                let $consoleParentDiv = $("#consoleParentDiv");
                $("#consoleDiv").append(formatConsoleLog(event.data));
                $consoleParentDiv.scrollTop($consoleParentDiv.prop("scrollHeight"));
            };

            //右侧面板初始化
            managerRightInit();
            //每分钟刷新一次
            setInterval(managerRightInit, 60000)
            //左侧面板初始化
            managerLeftInit();
        })

        //格式化控制台信息，上色
        function formatConsoleLog(logContent) {
            let color = "#000";
            if (logContent.indexOf("DEBUG") !== -1) {
                color = "#54cb39";
            } else if (logContent.indexOf("ERROE") !== -1 || logContent.indexOf("Exception") !== -1 || /at [a-z]{1,6}/g.test(logContent)) {
                color = "#c73c3c";
            } else if (logContent.indexOf("INFO") !== -1) {
                color = "#000";
            }
            return "<p style='color: " + color + "'>" + logContent + "</p>";
        }

        //面板左侧初始化
        function managerLeftInit() {
            ajaxHttp({
                type: 'GET',
                url: ctx + "/manager/managerLeft",
                success: function (res) {
                    const data = res.data;
                    $("#accessAllCountSpan").text(data.accessCount.all);
                    $("#accessTodayCountSpan").text(data.accessCount.today);
                }
            })
        }

        //面板右侧初始化
        let serverTimeInterval;

        function managerRightInit() {
            //硬件信息数据
            ajaxHttp({
                type: 'GET',
                url: ctx + "/manager/managerRight",
                success: function (res) {
                    const data = res.data;
                    //服务器运行时间
                    $("#serverStartTimeSpan").text(new Date(new Date().getTime() - data.serverUptime * 1000).Format("yyyy-MM-dd HH:mm:ss"))
                    let nowTime = new Date(data.serverUptime * 1000).getTime();
                    $("#serverTimeSpan").text(convertMilliSecondToTimeStr(nowTime))
                    //每秒刷新+1
                    clearInterval(serverTimeInterval);
                    serverTimeInterval = setInterval(function () {
                        nowTime += 1000;
                        $("#serverTimeSpan").text(convertMilliSecondToTimeStr(nowTime))
                    }, 1000);
                    //gc数据
                    $("#gcCountSpan").text(data.gcTime.count + "次");
                    $("#gcTimeSpan").text((data.gcTime.time).toFixed(3) + "s");
                    //线程数据
                    //峰值线程
                    let peakCount = data.jvmThread.peakCount;
                    let heightProportion = 100 / peakCount;
                    let $jvmGrdThreadLi = $("#jvmGrdThreadLi");
                    let $jvmActThreadLi = $("#jvmActThreadLi");
                    let $jvmPekThreadLi = $("#jvmPekThreadLi");
                    $jvmGrdThreadLi.text("GRD/" + data.jvmThread.daemonCount);
                    $jvmGrdThreadLi.css("height", data.jvmThread.daemonCount * heightProportion + "%");
                    $jvmGrdThreadLi.attr("title", "JVM当前守护线程：" + data.jvmThread.daemonCount);
                    $jvmActThreadLi.text("ACT/" + data.jvmThread.liveCount);
                    $jvmActThreadLi.css("height", data.jvmThread.liveCount * heightProportion + "%");
                    $jvmActThreadLi.attr("title", "JVM当前活跃线程：" + data.jvmThread.liveCount);
                    $jvmPekThreadLi.text("PEK/" + data.jvmThread.peakCount);
                    $jvmPekThreadLi.css("height", data.jvmThread.peakCount * heightProportion + "%");
                    $jvmPekThreadLi.attr("title", "JVM峰值线程：" + data.jvmThread.peakCount);
                    //硬件信息
                    let $diskUsageDiv = $("#diskUsageDiv");
                    $diskUsageDiv.css("width", (1 - data.diskSpace.details.free / data.diskSpace.details.total) * 100 + "%")
                    let diskTitle = "磁盘使用情况：" + ((data.diskSpace.details.total - data.diskSpace.details.free) / 1024 / 1024 / 1024).toFixed(2) + "G/" + (data.diskSpace.details.total / 1024 / 1024 / 1024).toFixed(2) + "G";
                    $diskUsageDiv.attr("title", diskTitle);
                    $("#diskUsageSpan").attr("title", diskTitle);
                    let $memoryUsageDiv = $("#memoryUsageDiv");
                    $memoryUsageDiv.css("width", (data.jvmMemory.used / (data.jvmMemory.committed + data.jvmMemory.used)) * 100 + "%");
                    let memoryTitle = "内存使用情况：" + (data.jvmMemory.used / 1024 / 1024).toFixed(2) + "M/" + ((data.jvmMemory.committed + data.jvmMemory.used) / 1024 / 1024).toFixed(2) + "M";
                    $memoryUsageDiv.attr("title", memoryTitle);
                    $("#memoryUsageSpan").attr("title", memoryTitle);
                    let $cpuUsageDiv = $("#cpuUsageDiv");
                    $cpuUsageDiv.css("width", data.cpuUsage + "%");
                    $cpuUsageDiv.attr("title", "CPU使用情况：" + (data.cpuUsage).toFixed(2) + "%/100%");
                    $("#cpuUsageSpan").attr("title", "CPU使用情况：" + (data.cpuUsage).toFixed(2) + "%/100%");
                    //请求最多的8个接口
                    let requestHtml = "";
                    let topCountLength = null;
                    for (let i = 0; i < data.uriList.length; i++) {
                        //只展示8个
                        if (i > 7) {
                            break;
                        }
                        const requestUri = data.uriList[i];
                        if (topCountLength == null) {
                            topCountLength = requestUri.RequestCount.toString().length;
                        }
                        requestHtml += "<li>" +
                            "               <span style='color: hsla(236,58%,58%,0.73)'>" + PrefixInteger(requestUri.RequestCount, topCountLength) + "次：</span>" +
                            "               <a target='_blank' href=" + projectHomeHttpUrl + "/druid/weburi-detail.html?uri=" + requestUri.URI + ">" +
                            "                   <span>" + requestUri.URI + "</span>" +
                            "               </a>" +
                            "           </li>"
                    }
                    $("#requestUl").html(requestHtml)
                }
            })
        }
    </script>
</div>
</html>