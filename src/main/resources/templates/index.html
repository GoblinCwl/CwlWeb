<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head th:replace="fragment/globalComponent::commonHead(~{::title},~{::link},~{::style})">
    <title>GoblinCwl - é¦–é¡µ</title>
    <link rel="stylesheet" th:href="@{/css/vueType.css}">
    <style>
        .timeStampSHow {
            color: #929e98;
        }

        div {
            overflow-x: hidden;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<!-- å·¦ä¾§ä¾§è¾¹æ  -->
<div th:replace="fragment/globalComponent::leftSiderBar"></div>


<!-- é¡µé¢å†…å®¹ -->
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="content">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div th:replace="fragment/globalComponent::topHeader"></div>


        <div class="top">
            <span class="options">â—‹ â—‹ â¦¿</span>
            <span class="title">GoblinCwl - ç»ˆç«¯</span>
        </div>
        <div id="terminal-console" class="console terminal-console">
            <div id="terminalDiv" class="text">
                <br><br>
                <p id="consoleInput">
                    <label id="chatInputLabel" for="chatInput" style="color: #2bd92b">
                        [<span id="nickName">unAuth</span>@goblincwl.cn] #

                    </label>
                    <input id="chatInput" type="text"
                           style="background-color:transparent;border:0;outline:none;"
                           name="t2"
                           value=""/>
                </p>
            </div>
        </div>

        <!--ç‰ˆæƒï¼Œå¤‡æ¡ˆ-->
        <span style="color: white;-moz-user-select:none;-webkit-user-select:none;user-select:none;">1</span>
        <div class="copywrite">
            <p style="text-align: center">
                Â© 2021 GoblinCwl
                <a href="https://beian.miit.gov.cn/" target="_blank">æ¹˜ICPå¤‡19013886å·</a>
            </p>
        </div>


    </div>
</div>

</body>
<div th:replace="fragment/globalComponent::commonFoot(~{::script})">
    <script th:src="@{/js/vueTypeJs/vue.min.js}"></script>
    <script th:src="@{/js/vueTypeJs/typed.min.js}"></script>
    <script th:src="@{/js/autoTyping/AutoTyping.min.js}"></script>
    <script>
        $(function () {
            terminalDataInit();
        });

        const $consoleInput = $("#consoleInput");

        //ç»ˆç«¯ä¿¡æ¯åˆå§‹åŒ–
        function terminalDataInit() {
            ajaxHttp({
                type: "GET",
                url: ctx + "/findTerminalData",
                beforeSend: function (request) {
                    // request.setRequestHeader("GoblinCwlRequestType", "api");
                    insertMessage("<span style='color: #c0a16b'>æ•°æ®è¯·æ±‚ä¸­...</span>", 0);
                },
                error: function () {
                    insertMessage("æ•°æ®è¯·æ±‚å¤±è´¥ï¼Œæœ‰ç©ºçš„è¯éº»çƒ¦è”ç³»ä¸‹ç«™é•¿å¤„ç†~", 50);
                },
                success: function (res) {
                    if (res != null && res.code === 200) {
                        const data = res.data;
                        insertMessage("æ‚¨æ˜¯ç¬¬<span style='color: orange;font-weight: bold'>" + data.accessIpCount + "</span>ä¸ªè®¿é—®æœ¬ç«™çš„åœ°å€ï¼Œç«™ç‚¹æ€»è®¡å·²è¢«è®¿é—®<span style='color: #3c763d;font-weight: bold'>" + data.accessCount + "</span>æ¬¡ã€‚", 50);
                        insertMessage("åŒä¸€åœ°å€è¶…è¿‡åŠå°æ—¶åå†æ¬¡è®¿é—®æ‰ä¼šè¿›è¡Œæ¬¡æ•°è®°å½•ã€‚", 100);
                        insertMessage("è®¤è¯ä¸­...", 200);
                        insertMessage("ä¸Šæ¬¡è®¿é—®: <span style='color: grey'>" + data.lastAccessTime + "</span>.", 800);
                        insertMessage("æœ¬æ¬¡è®¿é—®: <span style='color: dodgerblue'>" + data.accessTime + "</span>.", 800);
                        if (res.data.lastAccessTime === 'é¦–æ¬¡è®¿é—®') {
                            insertMessage("æ ¹æ®ä½ çš„ç¯å¢ƒï¼Œæˆ‘ç»™ä½ å–äº†ä¸ªåå­—ï¼š<span style='color: #38c0e2;font-weight: bold'>" + data.nickName + "</span>ã€‚âœ”", 850);
                        } else {
                            insertMessage("<span style='color: #38c0e2;font-weight: bold'>" + data.nickName + "</span>ï¼Œå…è®¸è®¿é—®ï¼âœ”", 850);
                        }
                        setTimeout(function () {
                            $("#nickName").text(data.nickName)
                        }, 900);
                        insertMessage("<span style='color: #E74C3C;font-weight: bold'>æ¬¢è¿æ¥åˆ°GoblinCwlçš„ä¸ªäººç½‘ç«™ï¼</span>", 950);

                        setTimeout(function () {
                            websocketInit()
                        }, 1000)
                    } else {
                        insertMessage(res.msg, 50);
                        insertMessage("æ•°æ®è¯·æ±‚å¤±è´¥ï¼Œæœ‰ç©ºçš„è¯éº»çƒ¦è”ç³»ä¸‹ç«™é•¿å¤„ç†~", 100);
                    }
                },
                complete: function () {
                }
            });
        }

        //websocketåˆå§‹åŒ–
        function websocketInit() {
            var socketUrl;
            if (url.indexOf("https") !== -1) {
                socketUrl = url.replace('https', 'wss') + 'websocket';
            } else {
                socketUrl = url.replace('http', 'ws') + 'websocket';
            }
            const webSocket = new WebSocket(socketUrl);
            webSocket.onerror = function (event) {
                insertMessage("<span style='color: red'>è¿æ¥å‘ç”Ÿå¼‚å¸¸ï¼Œä¿¡æ¯å¦‚ä¸‹ï¼šâŒ</span>");
                insertMessage("<span style='color: red'>" + event.data + "</span>");
                insertMessage("<span style='color: red'>å°è¯•åˆ·æ–°æˆ–è”ç³»ç«™é•¿å¤„ç†ï¼âŒ</span>");
            };
            //ä¸WebSocketå»ºç«‹è¿æ¥
            webSocket.onopen = function (event) {
                insertMessage("<span style='color: #c0a16b'>æ­£åœ¨è¿æ¥åˆ°èŠå¤©å®¤...</span>");
            };
            //å¤„ç†æœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯
            webSocket.onmessage = function (event) {
                let nowMessage = event.data;
                if (nowMessage.indexOf("{") === 0) {
                    const msgJson = JSON.parse(nowMessage);
                    const time = "<span style='color: #929e98'>[" + msgJson.sendTime + "]</span>";
                    let contentColor = msgJson.color;
                    if (contentColor == null) {
                        contentColor = randomColor();
                    }
                    const message = "<span style='color: " + contentColor + "'>" + msgJson.content + "</span>";
                    $consoleInput.before(time + " " + message + "<br>");
                } else {
                    insertMessage(nowMessage);
                }
                $('#terminal-console').scrollTop($('#terminal-console')[0].scrollHeight);
            };

            function sendMessage(message) {
                //å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯
                if (message.indexOf("/login") > 0) {
                    //å¦‚æœæ˜¯/loginå¼€å¤´ï¼Œåˆ™æ˜¯ç®¡ç†å‘˜ç™»é™†
                    let password = message.substr(message.lastIndexOf(" ") + 1);
                    ajaxHttp({
                        type: 'POST',
                        url: ctx + "/manager/login",
                        data: {
                            "password": password
                        },
                        error: function () {
                            insertMessage("<span style='color: red'>ç™»é™†å¼‚å¸¸ï¼âŒ</span>");
                        },
                        success: function (res) {
                            if (res.code === 200) {
                                //è®¾ç½®Token
                                localStorage.setItem("access_token", res.data);
                                insertMessage("<span style='color: green'>ç™»é™†æˆåŠŸï¼âœ”</span>");
                                addManagerUl();
                            } else {
                                insertMessage("<span style='color: red'>" + res.msg + "âŒ</span>");
                            }
                        }
                    })
                } else if (message.indexOf("/logout") > 0) {
                    //ç™»å‡º
                    ajaxHttp({
                        type: 'GET',
                        url: ctx + "/manager/logout",
                        error: function () {
                            insertMessage("<span style='color: red'>ç™»å‡ºå¼‚å¸¸ï¼âŒ</span>");
                        },
                        success: function (res) {
                            if (res.code === 200) {
                                insertMessage("<span style='color: #acac40'>ç™»å‡ºæˆåŠŸï¼âœ”</span>");
                                $('#managerLi').remove();
                                document.cookie = "Authorization=null";
                                localStorage.setItem("access_token", "");
                            } else {
                                insertMessage("<span style='color: red'>" + res.msg + "âŒ</span>");
                            }
                        }
                    })
                } else {
                    webSocket.send(message);
                }
            }

            const $chatInput = $("#chatInput");

            //åŠ¨æ€è®¾ç½®è¾“å…¥æ¡†çš„å®½åº¦
            $chatInput.width(($("#terminalDiv").width() - $("#chatInputLabel").width()) * 0.9)

            //ç›‘å¬ç»ˆç«¯ç‚¹å‡»
            $("#terminal-console").click(function () {
                $chatInput.focus();
            });

            //ç›‘å¬å›è½¦
            var time = 0;
            $chatInput.keydown(function (event) {
                const code = event.keyCode;
                //æŒ‰ä¸‹å›è½¦æ—¶
                if (code === 13) {
                    const message = $("#nickName").text() + ': ' + $chatInput.val();
                    //æ ¡éªŒä¿¡æ¯é•¿åº¦
                    if ($chatInput.val().length > 50) {
                        insertMessage("<span style='color: red'>å¤ªå¤šå•¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯é•¿è¯çŸ­è¯´å§ï¼ğŸ¤</span>")
                    } else if ($chatInput.val().length > 0) {
                        //åˆ¤æ–­è®¡æ—¶å™¨æ˜¯å¦å¤„äºå…³é—­çŠ¶æ€
                        if (time === 0) {
                            time = 10; //è®¾å®šé—´éš”æ—¶é—´ï¼ˆç§’ï¼‰

                            //å¯åŠ¨è®¡æ—¶å™¨ï¼Œå€’è®¡æ—¶timeç§’åè‡ªåŠ¨å…³é—­è®¡æ—¶å™¨ã€‚
                            var index = setInterval(function () {
                                time--;
                                if (time === 0) {
                                    clearInterval(index);
                                }
                            }, 1000);

                            //å‘é€æ¶ˆæ¯
                            sendMessage(message);
                            $chatInput.val('');
                        } else {
                            insertMessage("<span style='color: red'>å–å£èŒ¶æ­‡æ­‡å§ï¼Œ" + time + "ç§’å°±å¥½ï¼â˜•</span>")
                        }
                    }
                }
            })
        }

        //è¿½åŠ ç»ˆç«¯ä¿¡æ¯
        function insertMessage(message, time) {
            const $terminalConsole = $('#terminal-console');
            if (time != null) {
                setTimeout(function () {
                    $consoleInput.before(getMessageTimestamp() + message + "<br>");
                }, time);
            } else {
                $consoleInput.before(getMessageTimestamp() + message + "<br>");
            }
            $terminalConsole.scrollTop($terminalConsole[0].scrollHeight);
        }

        //è·å–å½“å‰æ—¶é—´è½´
        function getMessageTimestamp() {
            return "<span class='timeStampSHow'>"
                + "["
                + new Date().Format("HH:mm:ss")
                + "] "
                + "</span>";
        }
    </script>
</div>
</html>