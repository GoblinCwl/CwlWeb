<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head th:replace="fragment/globalComponent::commonHead(~{::title},~{::link},~{::style})">
    <title>GoblinCwl - 博客管理</title>
    <link th:href="@{/css/manager.css}" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/goblincwl/tablePage.css}">
    <link rel="stylesheet" th:href="@{/plugins/editormd/css/editormd.css}">
    <style>
    </style>
</head>
<body>
<!-- 左侧侧边栏 -->
<div th:replace="fragment/managerComponent::leftSiderBar"></div>

<!-- 页面内容 -->
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="content">
        <!-- 顶部导航 -->
        <div th:replace="fragment/globalComponent::topHeader"></div>

        <div class="col-sm-12" style="padding: 0 10px;padding-top: 1em">
            <ul class="nav nav-tabs" id="navList">
                <li data-name="blogTab" class="active">
                    <a data-toggle="tab" href="#blogTab" onclick="refreshTable('blog-table')">
                        文章管理
                    </a>
                </li>
            </ul>
            <div class="tab-content" id="tabContent">
                <div id="blogTab" class="tab-pane active">
                    <div class="table-responsive">
                        <div id="blog-toolbar" class="btn-group">
                            <button id="blog-toolbar-add" type="button"
                                    class="btn btn-success btn-sm rightSize toolbarBtn">
                                <i class="glyphicon glyphicon-plus toolbarIcon" aria-hidden="true"></i>新增
                            </button>
                            <button id=blog-toolbar-edit type="button"
                                    class="btn btn-info btn-sm rightSize toolbarBtn">
                                <i class="glyphicon glyphicon-pencil toolbarIcon" aria-hidden="true"></i>编辑
                            </button>
                            <button id="blog-toolbar-remove" type="button"
                                    class="btn btn-danger btn-sm rightSize toolbarBtn">
                                <i class="glyphicon glyphicon-remove " aria-hidden="true"></i>删除
                            </button>
                        </div>
                        <div class="form-inline table-search">
                            <div class="form-group">
                                <label for="blog-query-title"></label>
                                <input type="text" class="form-control input-sm"
                                       id="blog-query-title"
                                       placeholder="文章标题">
                            </div>
                        </div>
                        <table id="blog-table" class="table table-condensed text-nowrap my-table"></table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

</body>
<div th:replace="fragment/globalComponent::commonFoot(~{::script})">
    <script th:src="@{/js/goblincwl/tablePage.js}" type="text/javascript"></script>
    <script th:src="@{/plugins/editormd/editormd.min.js}"></script>
    <script>
        $(function () {
            //左侧导航
            $("#managerBlogLi").addClass("active")
            initData('blogTab')
        })

        //初始化表格
        function initData(name) {
            const tableOptions = genTableOptions();
            let url,                    //请求地址
                columns,                //列
                uniqueId,               //主键
                tableId,              //表格ID
                $table,                 //表格元素
                $toolbar,               //工具栏元素
                $singleBtnArray = [],   //单选按钮
                $multiBtnArray = [],    //多选按钮
                $queryInputArray = [];  //查询框
            switch (name) {
                case 'blogTab':
                    url = ctx + "/blog/list";
                    tableId = 'blog-table';
                    $table = $("#" + tableId);
                    $toolbar = $("#blog-toolbar");
                    uniqueId = "id";
                    //单选/多选按钮及事件
                    $("#blog-toolbar-add").on('click', function () {
                        blogAdd(tableId);
                    });
                    $singleBtnArray[0] = $("#blog-toolbar-edit");
                    $singleBtnArray[0].on('click', function () {
                        blogEdit(tableId)
                    });
                    $multiBtnArray[0] = $("#blog-toolbar-remove");
                    $multiBtnArray[0].on('click', function () {
                        blogRemove(tableId)
                    });
                    $queryInputArray[0] = $("#blogTab-query-title")
                    //自定义参数
                    tableOptions.queryParams = function (params) {
                        return $.extend(queryParams(params), {
                            title: $queryInputArray[0].val()
                        });
                    }
                    columns = [
                        {
                            checkbox: true,
                        },
                        {
                            title: '操作',
                            formatter: function (value, row, index) {//赋予的参数
                                return genTableOptionA('#5bc0de', '编辑', 'glyphicon-pencil', "editContent('" + row.title + "','" + row.id + "')") +
                                    genTableOptionA('#d9534f', '删除', 'glyphicon-remove', "blogRemove('" + tableId + "','" + row.id + "')")
                                    ;

                            }, //自定义方法，添加操作按钮,
                            switchable: false,
                            align: 'center',
                            width: 50,
                            cellStyle: function () {
                                const style = rowStyle(tableOptions);
                                style.css["border-right"] = "1px solid #ddd"
                                return style;
                            },
                        },
                        {
                            field: 'id',
                            title: '主键',
                            sortable: true,
                            sortName: "id",
                            align: 'center',
                            width: 50,
                        },
                        {
                            field: 'title',
                            title: '文章标题',
                            align: 'center',
                            width: 300
                        }, {
                            field: 'releaseTime',
                            title: '发布时间',
                            align: 'center',
                        }, {
                            field: 'updateTime',
                            title: '更新时间',
                            align: 'center',
                        }
                    ];
                    break;
            }


            //渲染表格
            $table.bootstrapTable(pushParamTableOptions(
                tableOptions,
                "GET",
                url,
                columns,
                uniqueId,
                $toolbar,
                $table,
                $singleBtnArray,
                $multiBtnArray,
                $queryInputArray
            ));
            //刷新按钮状态
            $table.bootstrapTable('getOptions').onUncheckAll();
        }


    </script>

    <!--键值对设置-->
    <script>
        function editContent(title, id) {
            xtip.open({
                type: 'url',
                content: '/manager/editBlog?id=' + id,
                title: '编辑 - ' + title,
                lock: true,
                width: '100%',
                height: '100%',
                min: true,
                shadeClose: false,
                shade: false,
                max: true,
                closeBtn: true,
            });
        }

        /*新增*/
        function blogAdd(tableId) {
            xtip.win({
                type: 'confirm',
                btn: ['保存', '取消'],
                icon: ['', '#5cb85c'],
                tip:
                    '<form class="form-horizontal">\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="blog-add-optKey" class="col-sm-2 control-label xtip-label">文章标题</label>' +
                    '    <div class="col-sm-10 xtip-input">' +
                    '      <input type="text" class="form-control input-sm table-modal-input" id="blog-add-optKey" placeholder="key">' +
                    '    </div>' +
                    '  </div>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="blog-add-optValue" class="col-sm-2 control-label xtip-label">文章标签</label>' +
                    '    <div class="col-sm-10 xtip-input">' +
                    '      <input type="text" class="form-control input-sm table-modal-input" id="blog-add-optValue" placeholder="value">' +
                    '    </div>' +
                    '  </div>\n' +
                    '  <div class="form-group">\n' +
                    '    <label for="blog-add-remark" class="col-sm-2 control-label xtip-label">文章内容</label>' +
                    '    <div class="col-sm-10 xtip-input">' +
                    '      <input type="text" class="form-control input-sm table-modal-input" id="blog-add-remark" placeholder="...">' +
                    '    </div>' +
                    '  </div>\n' +
                    '</form>'
                ,
                title: "新增键值对",
                width: '600px',
                maxWidth: '100%',
                height: '35em',
                shadeClose: false,
                btn1: function () {
                    ajaxHttp({
                        type: "POST",
                        url: ctx + "/manager/blog/add",
                        data: {
                            optKey: $("#blog-add-optKey").val(),
                            optValue: $("#blog-add-optValue").val(),
                            remark: $("#blog-add-remark").val()
                        },
                        beforeSend: function () {
                            this.loadId = xtip.load();
                        },
                        success: function (res) {
                            if (res != null && res.code === 200) {
                                xtip.msg(res.msg, {icon: 's', type: 'w'})
                                $("#" + tableId).bootstrapTable('refresh');
                            } else {
                                xtip.msg(res.msg, {icon: 'e', type: 'w'})
                            }
                        },
                        complete: function () {
                            xtip.close(this.loadId);
                        }
                    })
                }
            });
        }

        /*修改*/
        function blogEdit(tableId, id) {
            //获取选择的数据
            if (id == null) {
                //复选框所选数据
                const checkIdList = $("#" + tableId).bootstrapTable('getAllSelections');
                if (checkIdList.length === 1) {
                    id = checkIdList[0].id;
                } else {
                    xtip.msg("请选择一行数据", {icon: 'e', type: 'w'})
                    return;
                }
            }

            //回显
            ajaxHttp({
                type: "GET",
                url: ctx + "/manager/blog/" + optKey,
                beforeSend: function (request) {
                    this.loadId = xtip.load();
                },
                success: function (res) {
                    if (res != null && res.code === 200) {
                        xtip.win({
                            type: 'confirm', //alert 或 confirm
                            btn: ['保存', '取消'],
                            icon: ['', '#5bc0de'],
                            width: '400px',
                            tip:
                                '<form class="form-horizontal">\n' +
                                '  <div class="form-group">\n' +
                                '    <label for="blog-add-optKey" class="col-sm-2 control-label xtip-label">键</label>' +
                                '    <div class="col-sm-10 xtip-input">' +
                                '      <input disabled type="text" class="form-control input-sm table-modal-input" id="blog-add-optKey" placeholder="key" value="' + res.data.optKey + '">' +
                                '    </div>' +
                                '  </div>\n' +
                                '  <div class="form-group">\n' +
                                '    <label for="blog-add-optValue" class="col-sm-2 control-label xtip-label">值</label>' +
                                '    <div class="col-sm-10 xtip-input">' +
                                '      <input type="text" class="form-control input-sm table-modal-input" id="blog-add-optValue" placeholder="value" value="' + res.data.optValue + '">' +
                                '    </div>' +
                                '  </div>\n' +
                                '  <div class="form-group">\n' +
                                '    <label for="blog-add-remark" class="col-sm-2 control-label xtip-label">备注</label>' +
                                '    <div class="col-sm-10 xtip-input">' +
                                '      <input type="text" class="form-control input-sm table-modal-input" id="blog-add-remark" placeholder="..." value="' + res.data.remark + '">' +
                                '    </div>' +
                                '  </div>\n' +
                                '</form>'
                            ,
                            title: "修改键值对",
                            shadeClose: false,
                            btn1: function () {
                                ajaxHttp({
                                    type: "PUT",
                                    url: ctx + "/manager/blog/edit",
                                    data: {
                                        optKey: $("#blog-add-optKey").val(),
                                        optValue: $("#blog-add-optValue").val(),
                                        remark: $("#blog-add-remark").val()
                                    },
                                    beforeSend: function () {
                                        this.loadId = xtip.load();
                                    },
                                    success: function (res) {
                                        if (res != null && res.code === 200) {
                                            xtip.msg(res.msg, {icon: 's', type: 'w'})
                                            $("#" + tableId).bootstrapTable('refresh');
                                        } else {
                                            xtip.msg(res.msg, {icon: 'e', type: 'w'})
                                        }
                                    },
                                    complete: function () {
                                        $("#" + tableId).bootstrapTable('getOptions').onUncheckAll();
                                        xtip.close(this.loadId);
                                    }
                                })
                            }
                        });
                    } else {
                        xtip.msg(res.msg, {icon: 'e', type: 'w'})
                    }
                },
                complete: function () {
                    xtip.close(this.loadId);
                }
            })
        }

        /*删除*/
        function blogRemove(tableId, id) {
            //获取选择的数据
            if (id == null) {
                id = '';
                //复选框所选数据
                const checkIdList = $("#" + tableId).bootstrapTable('getAllSelections');
                if (checkIdList.length <= 0) {
                    xtip.msg("请选择一行数据", {icon: 'e', type: 'w'})
                    return;
                }
                for (let i = 0; i < checkIdList.length; i++) {
                    let checkIdListElement = checkIdList[i];
                    id += checkIdListElement.id += ",";
                }
            }
            xtip.confirm('确认删除所选数据？', function () {
                ajaxHttp({
                    type: "DELETE",
                    url: ctx + "/blog/remove",
                    data: {
                        ids: id
                    },
                    beforeSend: function () {
                        this.loadId = xtip.load();
                    },
                    success: function (res) {
                        if (res != null && res.code === 200) {
                            xtip.msg(res.msg, {icon: 's', type: 'w'})
                            $("#" + tableId).bootstrapTable('refresh');
                        } else {
                            xtip.msg(res.msg, {icon: 'e', type: 'w'})
                        }
                    },
                    complete: function () {
                        $("#" + tableId).bootstrapTable('getOptions').onUncheckAll();
                        xtip.close(this.loadId);
                    }
                })
            }, {icon: ['', '#d9534f']});
        }
    </script>
</div>
</html>